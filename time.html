<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">  
  <title>D3 equalizer</title>
  <!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<style>
  #player{
    background:steelblue;
    width:176px;
  }
  #time{
    background-color:#333333;
    color:steelblue;
    border-radius:10px 0px 0px 10px;
    width:auto;
    float:right;
    text-align:center;
    font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;
    font-size: 24px;
    font-style: normal;
  }
  #buttonGroup{
    float:center;
  }
  #playButton{

  }
  .highlight {
    background:yellow;
  }

  svg {
    background:#eeeeee;
    font: 10px sans-serif;
    border-radius:10px;
  }

#viz {

}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
  stroke-linejoin:round;
  stroke-linecap:round;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

</style>
</head>
<body>

  <audio id ="audioElement" src="./audio/Tinkle.mp3"></audio>
  
  <div class="container">
      <div id ="player">
        <g id="buttonGroup">
           <button type ="button" id="playButton" class="btn btn-default btn-md button-play" onclick=""> <span class="playToggle glyphicon glyphicon-play"></span></button>
         <button type ="button" id="stopButton" class="btn btn-default btn-md button-stop" onclick=""><span class="glyphicon glyphicon-stop"></span></button>
         <button type ="button" class="btn btn-default btn-md button-volume-down" onclick="document.getElementById('audioElement').volume-=0.1"><span class="glyphicon glyphicon-volume-down"></span></button>
         <button type ="button" class="btn btn-default btn-md button-volume-up" onclick="document.getElementById('audioElement').volume+=0.1"><span class="glyphicon glyphicon-volume-up"></span></button>
        </g>
        <p id="time"></p>
      </div>
      <div id ="viz"></div>
</div>

  <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script>

    var colorScale = d3.scale.linear()
            .domain([0,200])
            .range(["black","steelblue","chartreuse"]);
            //.range(["crimson", "chartreuse"]);

    $(document).ready(function () {
        //header div transition     
        d3.select("#player")
          .transition()
          .duration(1000)
          .style("width",$('#viz').width() + "px")
          .style("background-color","black");
        
        //html5 audio elements
          var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          var audioElement = document.getElementById('audioElement');
          var audioSrc = audioCtx.createMediaElementSource(audioElement);
          var analyser = audioCtx.createAnalyser();

          // Bind our analyser to the media element source.
          audioSrc.connect(analyser);
          audioSrc.connect(audioCtx.destination);

          //var frequencyData = new Uint8Array(analyser.frequencyBinCount);
          analyser.fftSize = 2048;
          var bufferLength = analyser.fftSize;
          var timeData = new Uint8Array(bufferLength);
          var formattedTime = new Date(null);
          var deltaT = 0; // 50ms 
          var start,
              end;

          //viz parameters      
          var n = 128,
              data = d3.range(n).map(function(){return 0});

          var margin = {top: 20, right: 20, bottom: 20, left: 40},
              width = 1140 - margin.left - margin.right,
              height = 500 - margin.top - margin.bottom;

          var x = d3.scale.linear()
              .domain([0, n - 1])
              .range([0, width]);

          var y = d3.scale.linear()
              .domain([-128, 127])
              .range([height, 0]);

          var line = d3.svg.line()
              .x(function(d, i) { return x(i); })
              .y(function(d, i) { return y(d); });

          var svg = d3.select("#viz").append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
            .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          svg.append("defs").append("clipPath")
              .attr("id", "clip")
            .append("rect")
              .attr("width", width)
              .attr("height", height);

          svg.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + y(0) + ")")
              .call(d3.svg.axis().scale(x).orient("bottom"));

          svg.append("g")
              .attr("class", "y axis")
              .call(d3.svg.axis().scale(y).orient("left"));

          var path = svg.append("g")
              .attr("clip-path", "url(#clip)")
            .append("path")
              .datum(data)
              .attr("class", "line")
              .attr("d", line);

          tick();

  function tick() {
            //start = new Date().getTime();
            // push a new data point onto the back
            // requestAnimationFrame(tick);
            analyser.getByteTimeDomainData(timeData);
            data.push(timeData[timeData.length-1]-128);

            // redraw the line, and slide it to the left
            path
                .attr("d", line)
                .attr("transform", null)
                .style("stroke",function(d){return colorScale(d)})
              .transition()
                .duration(deltaT) //this sets the interval
                .ease("linear")
                .attr("transform", "translate(" + x(-1) + ",0)")
                .each("end", tick);
            // pop the old data point off the front
            data.shift();
            //end = new Date().getTime();
            //console.log(end-start); 
          }
});

//window resize header transitions
$(window).resize(function(){
d3.select("#player")
  .transition()
  .duration(1000)
  .style("width",$('#viz').width() + "px")
  .style("background-color","black");})

//playButton pauseButton toggle
$("#playButton").click(function() {
  $(".playToggle").toggleClass("glyphicon-play glyphicon-pause");
  if($(".playToggle")[0].className == "playToggle glyphicon glyphicon-pause") { audioElement.play();};
  if($(".playToggle")[0].className == "playToggle glyphicon glyphicon-play") { audioElement.pause();};
});

//stopButton
$("#stopButton").click(function() {
  audioElement.pause();
  audioElement.currentTime = 0;
  if($(".playToggle")[0].className == "playToggle glyphicon glyphicon-pause") { 
    $(".playToggle").toggleClass("glyphicon-play glyphicon-pause");};
});

</script>

</body>
</html>