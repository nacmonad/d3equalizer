<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">	
	<title>D3 equalizer</title>
	<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<style>
	#player{
		background:steelblue;
		
		width:176px;
	}
	#time{
		background-color:#333333;
		color:steelblue;
		border-radius:10px 0px 0px 10px;
		width:auto;
		float:right;
		text-align:center;
		font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;
		font-size: 24px;
		font-style: normal;
	}
	#buttonGroup{
		float:center;
	}
	#playButton{

	}
	.highlight {
		background:yellow;
	}

	svg {
		background:#eeeeee;
	}
</style>
</head>
<body>

	<audio id ="audioElement" src="./audio/Tinkle.mp3"></audio>

	<div id ="player">
		<g id="buttonGroup">
  		 <button type ="button" id="playButton" class="btn btn-default btn-md button-play" onclick=""> <span class="playToggle glyphicon glyphicon-play"></span></button>
 		 <button type ="button" id="stopButton" class="btn btn-default btn-md button-stop" onclick=""><span class="glyphicon glyphicon-stop"></span></button>
 		 <button type ="button" class="btn btn-default btn-md button-volume-down" onclick="document.getElementById('audioElement').volume-=0.1"><span class="glyphicon glyphicon-volume-down"></span></button>
 		 <button type ="button" class="btn btn-default btn-md button-volume-up" onclick="document.getElementById('audioElement').volume+=0.1"><span class="glyphicon glyphicon-volume-up"></span></button>
 		</g>
 		<p id="time"></p>
	</div>


	<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script>

    var colorScale = d3.scale.linear()
    				.domain([0,200])
    				.range(["black","steelblue","chartreuse"]);
    				//.range(["crimson", "chartreuse"]);

    $(document).ready(function () {
        //header div transition    	
        d3.select("#player")
        	.transition()
        	.duration(1000)
        	.style("width",$(window).width() + "px")
        	.style("background-color","black");
        
        //html5 audio elements
          var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          var audioElement = document.getElementById('audioElement');
          var audioSrc = audioCtx.createMediaElementSource(audioElement);
          var analyser = audioCtx.createAnalyser();

          // Bind our analyser to the media element source.
          audioSrc.connect(analyser);
          audioSrc.connect(audioCtx.destination);

          //var frequencyData = new Uint8Array(analyser.frequencyBinCount);
          analyser.fftSize = 2048;
          var bufferLength = analyser.fftSize;
          var numberBars = 64;
          var frequencyData = new Uint8Array(numberBars);   //
          var timeData = new Uint8Array(bufferLength);


          var formattedTime = new Date(null);

          var svgHeight = '300';
          var svgWidth = '1200';
          var barPadding = '1';

          function createSvg(parent, height, width) {
            return d3.select(parent).append('svg').attr('height', height).attr('width', width);
          }

          var svg = createSvg('body', svgHeight, svgWidth);

          // Create our initial D3 chart.
          svg.selectAll('rect')
             .data(frequencyData)
             .enter()
             .append('rect')
             .attr('x', function (d, i) {
                return i * (svgWidth / frequencyData.length);
             })
             .attr('width', svgWidth / frequencyData.length - barPadding);

          // Continuously loop and update chart with frequency data.
          function renderChart() {

                     requestAnimationFrame(renderChart);

                     // Copy frequency data to frequencyData array.
                     analyser.getByteFrequencyData(frequencyData);
                       //console.log(frequencyData);
                     analyser.getByteTimeDomainData(timeData);
                    //console.log(timeData);


                     // Update d3 chart with new data.
                     svg.selectAll('rect')
                        .data(frequencyData)
                        .attr('y', function(d) {
                           return svgHeight - d;
                        })
                        .attr('height', function(d) {
                           return d;
                        })
                        .attr('fill', function(d) {
                           return colorScale(d);
                        });

                      //update time
                  //formattedTime.setSeconds(audioElement.currentTime);
                  //console.log(audioElement.currentTime.toFixed(3)*1000);
                  //console.log(formattedTime.getUTCMinutes().toPrecision(2) + ':' + formattedTime.getSeconds().toPrecision(2));
                 	$("#time").text(audioElement.currentTime.toFixed(2));
          }

          // Run the loop
          renderChart();

});

//window resize header transitions
$(window).resize(function(){
d3.select("#player")
	.transition()
	.duration(1000)
	.style("width",$(window).width() + "px")
	.style("background-color","black");})

//playButton pauseButton toggle
$("#playButton").click(function() {
	$(".playToggle").toggleClass("glyphicon-play glyphicon-pause");
	if($(".playToggle")[0].className == "playToggle glyphicon glyphicon-pause") { audioElement.play();};
	if($(".playToggle")[0].className == "playToggle glyphicon glyphicon-play") { audioElement.pause();};
});

//stopButton
$("#stopButton").click(function() {
	audioElement.pause();
	audioElement.currentTime = 0;
	if($(".playToggle")[0].className == "playToggle glyphicon glyphicon-pause") { 
		$(".playToggle").toggleClass("glyphicon-play glyphicon-pause");};
});

</script>

</body>
</html>